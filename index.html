<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–æ—Ç–æ-–±—É–¥–∫–∞</title>
    <style>
        /* BRANDING SECTION - –õ–ï–ì–ö–û –ó–ú–Ü–ù–Æ–Ñ–¢–¨–°–Ø */
        :root {
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --secondary-color: #f3f4f6;
            --accent-color: #10b981;
            --danger-color: #ef4444;
            --text-color: #1f2937;
            --background-color: #ffffff;
            --logo-url: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiByeD0iMjAiIGZpbGw9IiM2MzY2ZjEiLz4KPHRleHQgeD0iNTAiIHk9IjU1IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5MT0dPPC90ZXh0Pgo8L3N2Zz4K');
        }
        
        .logo {
            width: 120px;
            height: 120px;
            background-image: var(--logo-url);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin: 0 auto 2rem;
        }
        /* END BRANDING SECTION */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
        }

        .screen {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            background: linear-gradient(135deg, var(--secondary-color), #e5e7eb);
        }

        .hidden {
            display: none !important;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
            margin: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--accent-color);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: var(--text-color);
            border: 2px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
        }

        .camera-container {
            position: relative;
            width: 80vw;
            max-width: 600px;
            height: 60vh;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 2rem;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        #video, #capturedPhoto {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            max-width: 600px;
            width: 100%;
        }

        .photo-option {
            position: relative;
            aspect-ratio: 1;
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s ease;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .photo-option:hover {
            transform: scale(1.05);
        }

        .photo-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .spinner {
            width: 80px;
            height: 80px;
            border: 8px solid var(--secondary-color);
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 2rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .magic-text {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .inactivity-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .timer {
            font-size: 3rem;
            font-weight: bold;
            color: var(--danger-color);
            margin: 1rem 0;
        }

        .countdown {
            font-size: 1.5rem;
            margin: 1rem 0;
            color: var(--primary-color);
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 2rem;
            color: var(--text-color);
        }

        .subtitle {
            font-size: 1.5rem;
            margin-bottom: 2rem;
            color: #6b7280;
        }

        .print-preview {
            max-width: 300px;
            width: 100%;
            aspect-ratio: 1;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 2rem;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }

        .print-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .home-button {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .home-button:hover {
            background: var(--primary-hover);
            transform: scale(1.1);
        }

        .error-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .error-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .error-title {
            color: var(--danger-color);
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .error-message {
            margin-bottom: 2rem;
            color: var(--text-color);
            line-height: 1.5;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            min-width: 200px;
        }
    </style>
</head>
<body>
    <!-- –ü–æ—á–∞—Ç–∫–æ–≤–∏–π –µ–∫—Ä–∞–Ω -->
    <div id="startScreen" class="screen">
        <div class="logo"></div>
        <h1 class="title">–§–æ—Ç–æ-–±—É–¥–∫–∞</h1>
        <p class="subtitle">–°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–µ–π–º–æ–≤—ñ—Ä–Ω—ñ —Ñ–æ—Ç–æ –ø—Ä—è–º–æ –∑–∞—Ä–∞–∑!</p>
        <button class="btn btn-primary" id="startBtn">–ü–æ—á–∞—Ç–∏</button>
    </div>

    <!-- –ï–∫—Ä–∞–Ω –∫–∞–º–µ—Ä–∏ -->
    <div id="cameraScreen" class="screen hidden">
        <div class="camera-container">
            <video id="video" autoplay muted></video>
        </div>
        <button class="btn btn-primary" id="takePhotoBtn">üì∏ –ó—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ</button>
    </div>

    <!-- –ï–∫—Ä–∞–Ω –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è -->
    <div id="confirmScreen" class="screen hidden">
        <div class="camera-container">
            <img id="capturedPhoto" src="" alt="–ó—Ä–æ–±–ª–µ–Ω–µ —Ñ–æ—Ç–æ">
        </div>
        <div class="button-group">
            <button class="btn btn-success" id="processBtn">‚ú® –û–±—Ä–æ–±–∏—Ç–∏</button>
            <button class="btn btn-secondary" id="retakeBtn">üîÑ –ü–µ—Ä–µ—Ä–æ–±–∏—Ç–∏</button>
        </div>
    </div>

    <!-- –ï–∫—Ä–∞–Ω –æ–±—Ä–æ–±–∫–∏ -->
    <div id="processingScreen" class="screen hidden">
        <div class="spinner"></div>
        <p class="magic-text">–í—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –º–∞–≥—ñ—è...</p>
        <p class="subtitle">–°—Ç–≤–æ—Ä—é—î–º–æ –≤–∞—à—ñ –Ω–µ–π–º–æ–≤—ñ—Ä–Ω—ñ —Ñ–æ—Ç–æ</p>
    </div>

    <!-- –ï–∫—Ä–∞–Ω –≤–∏–±–æ—Ä—É —Ñ–æ—Ç–æ -->
    <div id="selectionScreen" class="screen hidden">
        <h2 class="title">–û–±–µ—Ä—ñ—Ç—å –Ω–∞–π–∫—Ä–∞—â–µ —Ñ–æ—Ç–æ</h2>
        <div class="photo-grid" id="photoGrid">
            <!-- –§–æ—Ç–æ –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
        </div>
    </div>

    <!-- –ï–∫—Ä–∞–Ω –¥—Ä—É–∫—É -->
    <div id="printScreen" class="screen hidden">
        <h2 class="title">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –¥—Ä—É–∫—É</h2>
        <div class="print-preview">
            <img id="selectedPhoto" src="" alt="–û–±—Ä–∞–Ω–µ —Ñ–æ—Ç–æ">
        </div>
        <div class="button-group">
            <button class="btn btn-success" id="confirmPrintBtn">üñ®Ô∏è –î—Ä—É–∫—É–≤–∞—Ç–∏</button>
            <button class="btn btn-secondary" id="backToSelectionBtn">‚¨ÖÔ∏è –û–±—Ä–∞—Ç–∏ —ñ–Ω—à–µ</button>
        </div>
    </div>

    <!-- –ï–∫—Ä–∞–Ω –¥—Ä—É–∫—É -->
    <div id="printingScreen" class="screen hidden">
        <div class="spinner"></div>
        <p class="magic-text">–î—Ä—É–∫—É—é...</p>
        <p class="subtitle">–í–∞—à–µ —Ñ–æ—Ç–æ –±—É–¥–µ –≥–æ—Ç–æ–≤–µ –∑–∞ –¥–µ–∫—ñ–ª—å–∫–∞ —Å–µ–∫—É–Ω–¥</p>
        <div class="countdown" id="printCountdown">10</div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –±–µ–∑–¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ -->
    <div id="inactivityModal" class="inactivity-modal hidden">
        <div class="modal-content">
            <h3>–í–∏ —â–µ —Ç—É—Ç?</h3>
            <div class="timer" id="inactivityTimer">20</div>
            <p>–°–µ—Å—ñ—è –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è —á–µ—Ä–µ–∑:</p>
            <div class="button-group">
                <button class="btn btn-primary" id="stayActiveBtn">–¢–∞–∫</button>
                <button class="btn btn-secondary" id="goToStartBtn">–ù–∞ –ø–æ—á–∞—Ç–æ–∫</button>
            </div>
        </div>
    </div>

    <canvas id="canvas" style="display: none;"></canvas>

    <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞ –≥–æ–ª–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω" -->
    <button class="home-button" id="homeBtn" title="–ù–∞ –≥–æ–ª–æ–≤–Ω–∏–π –µ–∫—Ä–∞–Ω">üè†</button>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –ø–æ–º–∏–ª–∫–∏ -->
    <div id="errorModal" class="error-modal hidden">
        <div class="error-content">
            <div class="error-title">–ü–æ–º–∏–ª–∫–∞!</div>
            <div class="error-message" id="errorMessage"></div>
            <button class="btn btn-primary" id="errorOkBtn">OK</button>
        </div>
    </div>

    <!-- –û–≤–µ—Ä–ª–µ–π –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>–í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–ø–∏—Ç...</p>
        </div>
    </div>

    <script>
        // –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø - –õ–ï–ì–ö–û –ó–ú–Ü–ù–Æ–Ñ–¢–¨–°–Ø
        const CONFIG = {
            WEBHOOK_PROCESS_URL: 'https://n8n.romanstudi0.pp.ua/webhook-test/b3b300d9-f7b5-401d-b880-d2d151dd311e', // –ó–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ –≤–∞—à webhook
            WEBHOOK_PRINT_URL: 'https://n8n.romanstudi0.pp.ua/webhook-test/b3b300d9-f7b5-401d-b880-d2d151dd311e', // –ó–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ –≤–∞—à webhook
            INACTIVITY_TIMEOUT: 30000, // 30 —Å–µ–∫—É–Ω–¥
            INACTIVITY_WARNING_TIME: 20000, // 20 —Å–µ–∫—É–Ω–¥
            PRINT_COUNTDOWN_TIME: 10000, // 10 —Å–µ–∫—É–Ω–¥
            WEBHOOK_TIMEOUT: 20000 // 10 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º-–∞—É—Ç –¥–ª—è webhook
        };

        let video;
        let canvas;
        let currentScreen = 'startScreen';
        let inactivityTimer;
        let inactivityWarningTimer;
        let selectedPhotoIndex = -1;
        let processedPhotos = [];
        let capturedImageData = null;

        function initializeApp() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            
            // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
            document.getElementById('startBtn').addEventListener('click', startCamera);
            document.getElementById('takePhotoBtn').addEventListener('click', takePhoto);
            document.getElementById('processBtn').addEventListener('click', processPhoto);
            document.getElementById('retakeBtn').addEventListener('click', retakePhoto);
            document.getElementById('confirmPrintBtn').addEventListener('click', confirmPrint);
            document.getElementById('backToSelectionBtn').addEventListener('click', backToSelection);
            document.getElementById('stayActiveBtn').addEventListener('click', stayActive);
            document.getElementById('goToStartBtn').addEventListener('click', goToStart);
            document.getElementById('homeBtn').addEventListener('click', goToStart);
            document.getElementById('errorOkBtn').addEventListener('click', hideErrorModal);
            
            resetInactivityTimer();
        }

        function showScreen(screenId) {
            // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ –µ–∫—Ä–∞–Ω–∏
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∏–π –µ–∫—Ä–∞–Ω
            document.getElementById(screenId).classList.remove('hidden');
            currentScreen = screenId;
            resetInactivityTimer();
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            clearTimeout(inactivityWarningTimer);
            hideInactivityModal();
            
            inactivityTimer = setTimeout(showInactivityWarning, CONFIG.INACTIVITY_TIMEOUT);
        }

        function showInactivityWarning() {
            document.getElementById('inactivityModal').classList.remove('hidden');
            let countdown = 20;
            const timerElement = document.getElementById('inactivityTimer');
            
            inactivityWarningTimer = setInterval(() => {
                countdown--;
                timerElement.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(inactivityWarningTimer);
                    goToStart();
                }
            }, 1000);
        }

        function hideInactivityModal() {
            document.getElementById('inactivityModal').classList.add('hidden');
            clearInterval(inactivityWarningTimer);
        }

        function stayActive() {
            hideInactivityModal();
            resetInactivityTimer();
        }

        function showErrorModal(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').classList.remove('hidden');
        }

        function hideErrorModal() {
            document.getElementById('errorModal').classList.add('hidden');
        }

        function showLoadingOverlay() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function goToStart() {
            hideInactivityModal();
            hideErrorModal();
            hideLoadingOverlay();
            stopCamera();
            showScreen('startScreen');
        }

        function showErrorModal(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').classList.remove('hidden');
        }

        function hideErrorModal() {
            document.getElementById('errorModal').classList.add('hidden');
        }

        function showLoadingOverlay() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∑–∞–ø–∏—Ç—É –∑ —Ç–∞–π–º-–∞—É—Ç–æ–º
        async function fetchWithTimeout(url, options, timeout = CONFIG.WEBHOOK_TIMEOUT) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error(`–¢–∞–π–º-–∞—É—Ç –∑–∞–ø–∏—Ç—É (${timeout/1000} —Å–µ–∫). –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç-–∑'—î–¥–Ω–∞–Ω–Ω—è –∞–±–æ —Å—Ç–∞–Ω —Å–µ—Ä–≤–µ—Ä–∞.`);
                }
                throw error;
            }
        }

        async function startCamera() {
            try {
                console.log('–°–ø—Ä–æ–±–∞ –∑–∞–ø—É—Å–∫—É –∫–∞–º–µ—Ä–∏...');
                
                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ navigator.mediaDevices
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Å—É—á–∞—Å–Ω–∏–π –±—Ä–∞—É–∑–µ—Ä (Chrome, Firefox, Safari).');
                }

                // –°–ø—Ä–æ–±–∞ –∑ —Ä—ñ–∑–Ω–∏–º–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏
                let stream;
                try {
                    // –°–ø–æ—á–∞—Ç–∫—É –ø—Ä–æ–±—É—î–º–æ –∑ –≤–∏—Å–æ–∫–æ—é —è–∫—ñ—Å—Ç—é
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 1280, min: 640 },
                            height: { ideal: 720, min: 480 },
                            facingMode: 'user'
                        },
                        audio: false
                    });
                } catch (error) {
                    console.log('–í–∏—Å–æ–∫–æ—è–∫—ñ—Å–Ω–µ –≤—ñ–¥–µ–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ, –ø—Ä–æ–±—É—î–º–æ –±–∞–∑–æ–≤—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è...', error);
                    // –Ø–∫—â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è, –ø—Ä–æ–±—É—î–º–æ –±–∞–∑–æ–≤—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: {
                            facingMode: 'user'
                        },
                        audio: false 
                    });
                }

                console.log('–ö–∞–º–µ—Ä–∞ —É—Å–ø—ñ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞');
                video.srcObject = stream;
                
                // –ß–µ–∫–∞—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–µ–æ
                video.onloadedmetadata = () => {
                    console.log('–í—ñ–¥–µ–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:', video.videoWidth + 'x' + video.videoHeight);
                    showScreen('cameraScreen');
                };

                // –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫ –≤—ñ–¥–µ–æ
                video.onerror = (error) => {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–µ–æ:', error);
                    throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ –≤—ñ–¥–µ–æ –∑ –∫–∞–º–µ—Ä–∏');
                };

            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏:', error);
                let errorMessage = '–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏: ';
                
                if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage += '–ö–∞–º–µ—Ä–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∞ –∫–∞–º–µ—Ä–∞.';
                } else if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage += '–î–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ. –î–æ–∑–≤–æ–ª—å—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∫–∞–º–µ—Ä–∏ –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage += '–ö–∞–º–µ—Ä–∞ –∑–∞–π–Ω—è—Ç–∞ —ñ–Ω—à–∏–º –¥–æ–¥–∞—Ç–∫–æ–º. –ó–∞–∫—Ä–∏–π—Ç–µ —ñ–Ω—à—ñ –ø—Ä–æ–≥—Ä–∞–º–∏, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å –∫–∞–º–µ—Ä—É.';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage += '–ö–∞–º–µ—Ä–∞ –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –∑–∞–ø–∏—Ç–∞–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏.';
                } else {
                    errorMessage += error.message || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞.';
                }
                
                errorMessage += '\n\n–ü–æ—Ä–∞–¥–∏:\n‚Ä¢ –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É\n‚Ä¢ –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –¥–æ–∑–≤–æ–ª–∏ –¥–ª—è —Å–∞–π—Ç—É\n‚Ä¢ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ HTTPS\n‚Ä¢ –°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π –±—Ä–∞—É–∑–µ—Ä';
                
                alert(errorMessage);
            }
        }

        function stopCamera() {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => {
                    track.stop();
                    console.log('–ö–∞–º–µ—Ä–∞ –∑—É–ø–∏–Ω–µ–Ω–∞');
                });
                video.srcObject = null;
            }
        }

        function takePhoto() {
            if (!video.videoWidth || !video.videoHeight) {
                alert('–í—ñ–¥–µ–æ —â–µ –Ω–µ –≥–æ—Ç–æ–≤–µ. –ó–∞—á–µ–∫–∞–π—Ç–µ —Å–µ–∫—É–Ω–¥—É —ñ —Å–ø—Ä–æ–±—É–π—Ç–µ –∑–Ω–æ–≤—É.');
                return;
            }

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            capturedImageData = imageData;
            
            document.getElementById('capturedPhoto').src = imageData;
            console.log('–§–æ—Ç–æ –∑—Ä–æ–±–ª–µ–Ω–æ, —Ä–æ–∑–º—ñ—Ä:', canvas.width + 'x' + canvas.height);
            showScreen('confirmScreen');
        }

        function retakePhoto() {
            showScreen('cameraScreen');
        }

        async function processPhoto() {
            showScreen('processingScreen');
            showLoadingOverlay();
            
            try {
                // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ base64 –≤ blob
                const response = await fetch(capturedImageData);
                const blob = await response.blob();
                
                // –°—Ç–≤–æ—Ä—é—î–º–æ FormData
                const formData = new FormData();
                formData.append('photo', blob, 'photo.jpg');
                
                console.log('–í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Ñ–æ—Ç–æ –Ω–∞ –æ–±—Ä–æ–±–∫—É...');
                
                // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ webhook –∑ —Ç–∞–π–º-–∞—É—Ç–æ–º
                const webhookResponse = await fetchWithTimeout(CONFIG.WEBHOOK_PROCESS_URL, {
                    method: 'POST',
                    body: formData
                });
                
                hideLoadingOverlay();
                
                if (!webhookResponse.ok) {
                    throw new Error(`–°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É: ${webhookResponse.status} ${webhookResponse.statusText}`);
                }
                
                console.log('–û—Ç—Ä–∏–º–∞–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞, —Å—Ç–∞—Ç—É—Å:', webhookResponse.status);
                
                const result = await webhookResponse.json();
                
                // –û—á—ñ–∫—É—î–º–æ, —â–æ webhook –ø–æ–≤–µ—Ä–Ω–µ –º–∞—Å–∏–≤ –∑ 4 —Ñ–æ—Ç–æ
                if (result.photos && result.photos.length === 4) {
                    processedPhotos = result.photos;
                    console.log('–û—Ç—Ä–∏–º–∞–Ω–æ 4 –æ–±—Ä–æ–±–ª–µ–Ω—ñ —Ñ–æ—Ç–æ');
                    displayProcessedPhotos();
                } else {
                    throw new Error('–°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å. –û—á—ñ–∫—É—î—Ç—å—Å—è 4 —Ñ–æ—Ç–æ.');
                }
                
            } catch (error) {
                hideLoadingOverlay();
                console.error('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —Ñ–æ—Ç–æ:', error);
                
                let errorMessage = '–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —Ñ–æ—Ç–æ:\n' + error.message;
                
                if (error.message.includes('Failed to fetch')) {
                    errorMessage += '\n\n–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:\n‚Ä¢ –ù–µ–º–∞—î —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç-–∑\'—î–¥–Ω–∞–Ω–Ω—è\n‚Ä¢ –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π\n‚Ä¢ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π URL webhook';
                }
                
                showErrorModal(errorMessage);
                
                // –£ –≤–∏–ø–∞–¥–∫—É –ø–æ–º–∏–ª–∫–∏ –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
                showScreen('confirmScreen');
            }
        }

        function displayProcessedPhotos() {
            const photoGrid = document.getElementById('photoGrid');
            photoGrid.innerHTML = '';
            
            processedPhotos.forEach((photoSrc, index) => {
                const photoDiv = document.createElement('div');
                photoDiv.className = 'photo-option';
                
                const img = document.createElement('img');
                img.src = photoSrc;
                img.alt = `–í–∞—Ä—ñ–∞–Ω—Ç ${index + 1}`;
                
                photoDiv.appendChild(img);
                photoGrid.appendChild(photoDiv);
                
                // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–¥—ñ–π —á–µ—Ä–µ–∑ addEventListener
                photoDiv.addEventListener('click', () => selectPhoto(index));
            });
            
            showScreen('selectionScreen');
        }

        function selectPhoto(index) {
            selectedPhotoIndex = index;
            document.getElementById('selectedPhoto').src = processedPhotos[index];
            showScreen('printScreen');
        }

        function backToSelection() {
            showScreen('selectionScreen');
        }

        async function confirmPrint() {
            showScreen('printingScreen');
            showLoadingOverlay();
            
            try {
                console.log('–í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–ø–∏—Ç –Ω–∞ –¥—Ä—É–∫ —Ñ–æ—Ç–æ –Ω–æ–º–µ—Ä:', selectedPhotoIndex);
                
                // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ webhook –∑ –Ω–æ–º–µ—Ä–æ–º –æ–±—Ä–∞–Ω–æ–≥–æ —Ñ–æ—Ç–æ
                const webhookResponse = await fetchWithTimeout(CONFIG.WEBHOOK_PRINT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        photoIndex: selectedPhotoIndex,
                        timestamp: new Date().toISOString()
                    })
                });
                
                hideLoadingOverlay();
                
                if (!webhookResponse.ok) {
                    throw new Error(`–ü–æ–º–∏–ª–∫–∞ –¥—Ä—É–∫—É: ${webhookResponse.status} ${webhookResponse.statusText}`);
                }
                
                console.log('–ó–∞–ø–∏—Ç –Ω–∞ –¥—Ä—É–∫ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∏–π, —Å—Ç–∞—Ç—É—Å:', webhookResponse.status);
                
            } catch (error) {
                hideLoadingOverlay();
                console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –Ω–∞ –¥—Ä—É–∫:', error);
                
                let errorMessage = '–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –Ω–∞ –¥—Ä—É–∫:\n' + error.message;
                
                if (error.message.includes('Failed to fetch')) {
                    errorMessage += '\n\n–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:\n‚Ä¢ –ù–µ–º–∞—î —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç-–∑\'—î–¥–Ω–∞–Ω–Ω—è\n‚Ä¢ –ü—Ä–∏–Ω—Ç–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π\n‚Ä¢ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π URL webhook';
                }
                
                showErrorModal(errorMessage);
                
                // –£ –≤–∏–ø–∞–¥–∫—É –ø–æ–º–∏–ª–∫–∏ –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ –≤–∏–±–æ—Ä—É –¥—Ä—É–∫—É
                showScreen('printScreen');
                return;
            }
            
            // –ó–≤–æ—Ä–æ—Ç–Ω—ñ–π –≤—ñ–¥–ª—ñ–∫ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∑–∞–ø–∏—Ç —É—Å–ø—ñ—à–Ω–∏–π
            let countdown = 10;
            const countdownElement = document.getElementById('printCountdown');
            
            const countdownInterval = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    finishSession();
                }
            }, 1000);
        }

        function finishSession() {
            stopCamera();
            selectedPhotoIndex = -1;
            processedPhotos = [];
            capturedImageData = null;
            showScreen('startScreen');
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        document.addEventListener('click', resetInactivityTimer);
        document.addEventListener('touchstart', resetInactivityTimer);
        document.addEventListener('keydown', resetInactivityTimer);
    </script>
</body>
</html>
